<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asset Manager Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#d32f2f",
              "primary-light": "#ff4d4f",
              secondary: "#52c41a",
              "light-gray": "#f5f5f5",
              "mid-gray": "#e8e8e8",
              "dark-gray": "#8c8c8c",
              "nav-active": "#fff7f7",
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      @layer utilities {
        .card-shadow {
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .hover-lift {
          transition: transform 0.2s, box-shadow 0.2s;
        }
        .hover-lift:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        .nav-active {
          background-color: #fff7f7;
          border-left: 4px solid #ff4d4f;
        }
        .gradient-bg {
          background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
      }
    </style>
    <style>
      /* ========== RESET ========== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }

      :root {
        --primary: #ff3a46; /* 鲜艳的红色作为主色调 */
        --primary-light: #ff5c65;
        --primary-dark: #e02a36;
        --secondary: #3b82f6; /* 亮蓝色作为辅助色 */
        --success: #10b981; /* 绿色表示正面数据 */
        --danger: #ef4444; /* 深红色表示负面数据 */
        --dark: #1e293b; /* 深色文本 */
        --light: #f8fafc; /* 浅色背景 */
        --gray: #94a3b8; /* 灰色文本 */
        --border: #e2e8f0; /* 边框颜色 */
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --transition: all 0.3s ease;
      }

      body {
        background-color: var(--light);
        color: var(--dark);
        display: flex;
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }

      /* ========== MAIN CONTENT ========== */
      .main {
        flex: 1;
        padding: 30px;
        transition: var(--transition);
        margin-left: 260px; /* 为固定侧边栏留出空间 */
      }

      .sidebar.collapsed ~ .main {
        margin-left: 80px; /* 侧边栏折叠时调整主内容位置 */
      }

      .top-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .greeting h1 {
        font-size: 1.6rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--dark);
      }

      .greeting p {
        font-size: 0.95rem;
        color: var(--gray);
      }

      .toggle-btn {
        background-color: white;
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
      }

      .toggle-btn:hover {
        background-color: var(--light);
        box-shadow: var(--shadow);
        color: var(--primary);
        border-color: var(--primary-light);
      }

      /* 其他样式保持不变 */
      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background-color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        transition: var(--transition);
        border-top: 4px solid var(--primary);
      }

      .card:nth-child(2) {
        border-top-color: var(--secondary);
      }

      .card:nth-child(3) {
        border-top-color: var(--success);
      }

      .card:nth-child(4) {
        border-top-color: var(--danger);
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
      }

      .card-header {
        font-size: 0.9rem;
        color: var(--gray);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card-header i {
        opacity: 0.7;
      }

      .card-value {
        font-size: 1.6rem;
        font-weight: 600;
        margin-bottom: 4px;
        transition: var(--transition);
      }

      .card-metric {
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .card-positive {
        color: var(--success);
      }

      .card-negative {
        color: var(--danger);
      }

      .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .chart-card {
        background-color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        transition: var(--transition);
      }

      .chart-card:hover {
        box-shadow: var(--shadow-hover);
      }

      .chart-card h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--dark);
      }

      .chart-card h3 i {
        color: var(--primary);
      }

      .chart-container {
        width: 100%;
        height: 400px;
        position: relative;
      }

      .holdings-section {
        background-color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        transition: var(--transition);
      }

      .holdings-section:hover {
        box-shadow: var(--shadow-hover);
      }

      .holdings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .holdings-header h2 {
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--dark);
      }

      .holdings-header h2 i {
        color: var(--primary);
      }

      .holdings-header a {
        color: var(--primary);
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: var(--transition);
      }

      .holdings-header a:hover {
        color: var(--primary-dark);
      }

      .holdings-table {
        width: 100%;
        border-collapse: collapse;
      }

      .holdings-table th,
      .holdings-table td {
        padding: 14px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }

      .holdings-table th {
        font-weight: 600;
        color: var(--gray);
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
      }

      .holdings-table tr:last-child td {
        border-bottom: none;
      }

      .holdings-table tr:hover td {
        background-color: rgba(255, 58, 70, 0.02);
      }

      .symbol {
        font-weight: 600;
      }

      .price {
        font-family: "Courier New", monospace;
      }

      .value {
        font-weight: 600;
      }

      .positive {
        color: var(--success);
      }

      .negative {
        color: var(--danger);
      }

      .return-positive {
    color: #10b981; /* 绿色表示正回报 */
  }
  .return-negative {
    color: #ef4444; /* 红色表示负回报 */
  }

      @media (max-width: 1024px) {
        .charts-section {
          grid-template-columns: 1fr;
        }

        .cards-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.collapsed {
          transform: translateX(0);
          width: 80px;
        }

        .sidebar.expanded {
          transform: translateX(0);
          width: 260px;
        }

        .mobile-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 5;
          display: none;
        }

        .mobile-overlay.active {
          display: block;
        }

        .mobile-menu-btn {
          display: block;
          position: fixed;
          top: 20px;
          left: 20px;
          z-index: 20;
          background-color: white;
          width: 40px;
          height: 40px;
          border-radius: 8px;
          box-shadow: var(--shadow);
          border: none;
          color: var(--primary);
          font-size: 1.2rem;
          cursor: pointer;
        }

        .main {
          padding: 20px;
          margin-left: 0;
          margin-top: 40px;
        }

        .sidebar.collapsed ~ .main {
          margin-left: 80px;
        }

        .cards-grid {
          grid-template-columns: 1fr;
        }

        .chart-container {
          height: 300px;
        }
      }
    </style>
  </head>
  <body>
    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
      <i class="fas fa-bars"></i>
    </button>

    <!-- 移动端遮罩层 -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- 侧边栏 -->
    <div id="sidebar-container"></div>
    <!-- 主内容区域 -->
    <div class="main">
      <!-- 顶部欢迎区 -->
      <div class="top-section">
        <div class="greeting">
          <h1>Welcome back, Team8</h1>
          <p>Here's your portfolio overview for today</p>
        </div>
        <button class="toggle-btn" id="hideBalanceBtn">
          <i class="fas fa-eye-slash"></i>
          <span>Hide Balance</span>
        </button>
      </div>

      <!-- 数据卡片区 -->
      <div class="cards-grid" id="cardsGrid">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-wallet"></i>
            Total Assets
          </div>
          <div class="card-value" id="totalAssets"></div>
          <div class="card-metric card-positive">
            <i class="fas fa-arrow-up"></i>
            +5.70% Total Return
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <i class="fas fa-money-bill-wave"></i>
            Cash Balance
          </div>
          <div class="card-value" id="cashBalance"></div>
          <div class="card-metric">
            <i class="fas fa-check-circle"></i>
            Available Funds
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <i class="fas fa-chart-line"></i>
            Stock Holdings
          </div>
          <div class="card-value" id="stockHoldings"></div>
          <div class="card-metric">
            <i class="fas fa-chart-pie"></i>
            Market Value
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <i class="fas fa-balance-scale"></i>
            P&L
          </div>
          <div class="card-value card-positive" id="pnl"></div>
          <div class="card-metric card-positive">
            <i class="fas fa-arrow-up"></i>
            +5.70%
          </div>
        </div>
      </div>

      <!-- 图表区 -->
      <div class="charts-section">
        <!-- 资产表现图表 -->
        <div class="chart-card">
          <h3>
            <i class="fas fa-chart-line"></i>
            Asset Performance (Past 6 Months)
          </h3>
          <div class="chart-container">
            <canvas id="assetChart"></canvas>
          </div>
        </div>
        <!-- 资产配置图表 -->
        <div class="chart-card">
          <h3>
            <i class="fas fa-pie-chart"></i>
            Asset Allocation
          </h3>
          <div
            class="chart-container"
            style="
              height: 360px;
              display: flex;
              flex-direction: column;
              justify-content: flex-end;
            "
          >
            <canvas id="allocationChart"></canvas>
          </div>
        </div>
      </div>

      <!-- 当前持仓区 -->
<div class="holdings-section">
  <div class="holdings-header">
    <h2>
      <i class="fas fa-list"></i>
      Current Holdings
    </h2>
    <a href="stock.html">
      <i class="fas fa-external-link-alt"></i>
      View All
    </a>
  </div>
  <table class="holdings-table">
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Return</th>
        <th>Value <i class="fas fa-sort-amount-down ml-1"></i></th>
      </tr>
    </thead>
    <tbody id="holdingsTableBody">
      <!-- 数据将通过JavaScript动态填充 -->
    </tbody>
  </table>
</div>
    <script>
      let userId = 1; // 假设用户ID为1，实际应用中应从登录状态获取
      let stockData; // 原始股票数据
      let stockHoldings = []; // 全局股票持仓数据，用于各种显示
      let stockHoldingsLoaded = false; // 标记是否已加载股票持仓数据
      
      // 缓存资产数据，用于显示/隐藏余额功能
      let cachedAssetData = {
        totalAssets: null,
        cashBalance: null,
        stockHoldingsValue: null,
        pnl: null,
        tableHtml: null // 缓存表格HTML内容
      };

      // load sidebar
      fetch("/sidebar.html")
        .then((response) => response.text())
        .then((html) => {
          document.getElementById("sidebar-container").innerHTML = html;
          
          // 侧边栏加载完成后，手动设置当前页面的活跃状态
          setTimeout(() => {
            const navItems = document.querySelectorAll('.sidebar-nav a');
            navItems.forEach(item => {
              item.classList.remove('active');
              if (item.getAttribute('href') === 'assetdashboard.html') {
                item.classList.add('active');
              }
            });
          }, 100);
        })
        .catch((error) => console.error("加载侧边栏失败:", error));

      fetchAndDisplayHoldings();
      fetchAssetInfo();

      // 获取股票持仓数据的全局函数
      async function fetchStockHoldings() {
        if (stockHoldingsLoaded) {
          return stockHoldings; // 如果已加载，直接返回缓存数据
        }

        try {
          console.log('开始获取股票持仓数据...'); // 调试信息
          const response = await fetch(`http://localhost:3000/api/user/${userId}/assets/details`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const resData = await response.json();
          console.log('API返回数据:', resData); // 调试信息

          // 处理API响应数据格式
          if (Array.isArray(resData)) {
            stockData = resData;
          } else if (resData.data && Array.isArray(resData.data)) {
            stockData = resData.data;
          } else {
            stockData = [];
          }
          
          // 确保stockData是数组
          if (!Array.isArray(stockData)) {
            console.warn('API返回的数据不是数组格式:', stockData);
            throw new Error('API返回的数据格式不正确');
          }
          
          // 筛选股票类型资产并按总价值倒序排序
          stockHoldings = stockData
            .filter(item => item.assetType === 'stock')
            .sort((a, b) => b.currentValue - a.currentValue);
          
          stockHoldingsLoaded = true; // 标记已加载
          console.log('股票持仓数据加载完成:', stockHoldings); // 调试信息
          
          return stockHoldings;
        } catch (error) {
          console.error('获取股票持仓数据失败:', error);
          stockHoldings = []; // 失败时设为空数组
          return stockHoldings;
        }
      }

      async function fetchAssetInfo() {
        try {
          // 后端API地址（假设后端运行在3000端口）
          const cashResponse = await fetch(
            `http://localhost:3000/api/user/${userId}/assets/cash`
          );
          const stockResponse = await fetch(
            `http://localhost:3000/api/user/${userId}/assets/stocks`
          );
          const costResponse = await fetch(
            `http://localhost:3000/api/user/${userId}/assets/stocks/cost`
          );
          if (!cashResponse.ok || !stockResponse.ok || !costResponse.ok) {
            // 如果需要，可以在这里处理错误，比如显示一个提示信息
            throw new Error("Network response was not ok");
          }
          const stockData = await stockResponse.json();
          const cashData = await cashResponse.json();
          const costData = await costResponse.json();

          const totalAssets = Number(cashData.totalCash) + stockData.totalValue;
          const cashBalance = Number(cashData.totalCash);
          const stockHoldingsValue = stockData.totalValue;
          const pnlValue = stockData.totalValue - costData.totalCost;

          // 缓存资产数据
          cachedAssetData.totalAssets = `$${totalAssets.toFixed(2)}`;
          cachedAssetData.cashBalance = `$${cashBalance.toFixed(2)}`;
          cachedAssetData.stockHoldingsValue = `$${stockHoldingsValue.toFixed(2)}`;
          cachedAssetData.pnl = `$${pnlValue.toFixed(2)}`;

          // 更新页面上的总资产显示
          document.getElementById("totalAssets").textContent = cachedAssetData.totalAssets;
          // 更新页面上的现金资产显示
          document.getElementById("cashBalance").textContent = cachedAssetData.cashBalance;
          // 更新页面上的股票持仓显示
          document.getElementById("stockHoldings").textContent = cachedAssetData.stockHoldingsValue;
          document.getElementById("pnl").textContent = cachedAssetData.pnl;

          // 获取全局股票持仓数据用于饼图
          await fetchStockHoldings(); // 确保股票持仓数据已加载
          
          // 将股票持仓数据转换为饼图所需格式
          const stockHoldingsForChart = stockHoldings.map(stock => ({
            symbol: stock.symbol,
            value: stock.currentValue
          }));

          const assetData = {
            cashAmount: Number(cashData.totalCash),
            totalAssets: totalAssets,
            stockHoldings: stockHoldingsForChart,
          };

          // 更新饼图
          createAllocationChart(assetData);
        } catch (error) {
          console.error("获取资产信息失败:", error);
          // 如果API调用失败，使用默认数据创建饼图
          const fallbackAssetData = {
            cashAmount: 5000,
            totalAssets: 15000,
            stockHoldings: [], // 空数组，只显示现金
          };
          createAllocationChart(fallbackAssetData);
        }
      }

      //current holdings加载function
      async function fetchAndDisplayHoldings() {
        try {
          // 使用全局函数获取股票持仓数据
          await fetchStockHoldings();
          
          console.log('开始显示持仓数据...'); // 调试信息
          
          // 获取表格主体元素
          const tableBody = document.getElementById('holdingsTableBody');
          tableBody.innerHTML = ''; // 清空现有内容
      
          // 遍历全局股票持仓数据并生成表格行
          stockHoldings.forEach(stock => {
            // 计算回报率
            const returnRate = ((stock.currentValue - stock.totalCost) / stock.totalCost) * 100;
            // 根据回报率正负设置样式类
            const returnClass = returnRate >= 0 ? 'return-positive' : 'return-negative';
            // 创建表格行
            const row = document.createElement('tr');
            // 格式化数据显示
            const quantity = stock.quantity % 1 === 0 ? stock.quantity.toFixed(0) : stock.quantity.toFixed(2);
            const currentPrice = `$${stock.currentPrice.toFixed(2)}`;
            const value = `$${stock.currentValue.toFixed(2)}`;
            const rateText = `${returnRate.toFixed(2)}%`;
            // 设置行内容
            row.innerHTML = `
              <td class="symbol">${stock.symbol}</td>
              <td>${quantity}</td>
              <td class="price">${currentPrice}</td>
              <td class="${returnClass}">
                ${returnRate >= 0 ? '+' : ''}${rateText}
              </td>
              <td class="value" data-original="${value}">${value}</td>
            `;
            tableBody.appendChild(row);
          });
          
          // 缓存表格HTML内容
          cachedAssetData.tableHtml = tableBody.innerHTML;
          
          console.log('表格更新完成'); // 调试信息
        } catch (error) {
          console.error('显示持仓数据失败:', error);
          // 如果失败，保持表格为空或显示错误信息
        }
      }

      // 刷新股票持仓数据的函数
      async function refreshStockHoldings() {
        stockHoldingsLoaded = false; // 重置加载标记
        stockHoldings = []; // 清空缓存
        return await fetchStockHoldings(); // 重新获取数据
      }

      // 恢复缓存数据的函数
      function restoreCachedData() {
        if (cachedAssetData.totalAssets) {
          document.getElementById("totalAssets").textContent = cachedAssetData.totalAssets;
        }
        if (cachedAssetData.cashBalance) {
          document.getElementById("cashBalance").textContent = cachedAssetData.cashBalance;
        }
        if (cachedAssetData.stockHoldingsValue) {
          document.getElementById("stockHoldings").textContent = cachedAssetData.stockHoldingsValue;
        }
        if (cachedAssetData.pnl) {
          document.getElementById("pnl").textContent = cachedAssetData.pnl;
        }
        if (cachedAssetData.tableHtml) {
          document.getElementById('holdingsTableBody').innerHTML = cachedAssetData.tableHtml;
        }
      }
      

// 显示模拟数据的函数
// function displayMockHoldings() {
//   const mockData = [
//     {
//       symbol: "GOOGL",
//       quantity: 5,
//       currentPrice: 1250.00,
//       currentValue: 6250.00,
//       totalCost: 6000.00
//     },
//     {
//       symbol: "MSFT", 
//       quantity: 8,
//       currentPrice: 350.00,
//       currentValue: 2800.00,
//       totalCost: 2700.00
//     },
//     {
//       symbol: "META",
//       quantity: 6,
//       currentPrice: 295.00,
//       currentValue: 1770.00,
//       totalCost: 1800.00
//     },
//     {
//       symbol: "AAPL",
//       quantity: 10,
//       currentPrice: 175.00,
//       currentValue: 1750.00,
//       totalCost: 1700.00
//     },
//     {
//       symbol: "NVDA",
//       quantity: 4,
//       currentPrice: 420.00,
//       currentValue: 1680.00,
//       totalCost: 1600.00
//     }
//   ];

//   const tableBody = document.getElementById('holdingsTableBody');
//   tableBody.innerHTML = '';

//   mockData.forEach(stock => {
//     const returnRate = ((stock.currentValue - stock.totalCost) / stock.totalCost) * 100;
//     const returnClass = returnRate >= 0 ? 'return-positive' : 'return-negative';
    
//     const row = document.createElement('tr');
//     const quantity = stock.quantity % 1 === 0 ? stock.quantity.toFixed(0) : stock.quantity.toFixed(2);
//     const currentPrice = `$${stock.currentPrice.toFixed(2)}`;
//     const value = `$${stock.currentValue.toFixed(2)}`;
//     const rateText = `${returnRate.toFixed(2)}%`;
    
//     row.innerHTML = `
//       <td class="symbol">${stock.symbol}</td>
//       <td>${quantity}</td>
//       <td class="price">${currentPrice}</td>
//       <td class="${returnClass}">
//         ${returnRate >= 0 ? '+' : ''}${rateText}
//       </td>
//       <td class="value" data-original="${value}">${value}</td>
//     `;
    
//     tableBody.appendChild(row);
//   });
// }

      // 初始化Chart.js图表
      const ctx = document.getElementById("assetChart").getContext("2d");
      const assetChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
          datasets: [
            {
              data: [42000, 45500, 41800, 48200, 52000, 50500],
              borderColor: "#d32f2f",
              backgroundColor: "rgba(211, 47, 47, 0.1)",
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: "#d32f2f",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          aspectRatio: 2,
          plugins: {
            legend: {
              display: false,
            },
          },
          layout: {
            padding: {
              top: 20,
              bottom: 20,
              left: 10,
              right: 10,
            },
          },
          scales: {
            y: {
              beginAtZero: false,
              min: 35000,
              max: 55000,
              title: {
                display: false,
              },
              ticks: {
                callback: function (value) {
                  return "$" + value.toLocaleString();
                },
                font: {
                  size: 12,
                },
                padding: 8,
                maxTicksLimit: 8,
              },
              grid: {
                color: "rgba(0, 0, 0, 0.1)",
                lineWidth: 1,
              },
            },
            x: {
              title: {
                display: false,
              },
              ticks: {
                font: {
                  size: 11,
                },
              },
              grid: {
                color: "rgba(0, 0, 0, 0.1)",
              },
            },
          },
          interaction: {
            intersect: false,
            mode: "index",
          },
          elements: {
            line: {
              borderCapStyle: "round",
            },
          },
        },
      });

      // 初始化资产配置饼图 - 使用真实的用户资产数据
      const pieCtx = document
        .getElementById("allocationChart")
        .getContext("2d");

      // 全局变量存储饼图实例
      let allocationChart = null;

      // 创建资产配置饼图的函数
      function createAllocationChart(assetData) {
        // 如果图表已存在，先销毁
        if (allocationChart) {
          allocationChart.destroy();
        }

        const { cashAmount, stockHoldings, totalAssets } = assetData;

        // 确保 stockHoldings 是数组，如果不是则初始化为空数组
        const safeStockHoldings = Array.isArray(stockHoldings) ? stockHoldings : [];

        // 按价值排序股票持仓，取前三
        const sortedStocks = safeStockHoldings.sort((a, b) => b.value - a.value);
        const topThreeStocks = sortedStocks.slice(0, 3);
        const otherStocks = sortedStocks.slice(3);

        // 计算其他股票的总价值
        const otherStocksValue = otherStocks.reduce(
          (sum, stock) => sum + stock.value,
          0
        );

        // 准备图表数据
        const labels = ["Cash"];
        const data = [cashAmount];
        const colors = ["#3b82f6"]; // 蓝色 - 现金

        // 添加前三大股票
        topThreeStocks.forEach((stock, index) => {
          labels.push(stock.symbol);
          data.push(stock.value);
          // 为前三大股票分配不同颜色
          const stockColors = ["#d32f2f", "#10b981", "#f59e0b"]; // 红、绿、橙
          colors.push(stockColors[index] || "#8b5cf6");
        });

        // 如果有其他股票，添加到图表
        if (otherStocksValue > 0) {
          labels.push("Other Stocks");
          data.push(otherStocksValue);
          colors.push("#64748b"); // 灰色 - 其他股票
        }

        // 计算百分比
        const percentages = data.map((value) =>
          ((value / totalAssets) * 100).toFixed(1)
        );

        allocationChart = new Chart(pieCtx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: colors,
                borderColor: "#ffffff",
                borderWidth: 3,
                hoverOffset: 10,
                hoverBorderWidth: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "50%",
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: {
                  usePointStyle: true,
                  padding: 15,
                  font: {
                    size: 11,
                    weight: "500",
                  },
                  generateLabels: function (chart) {
                    const data = chart.data;
                    if (data.labels.length && data.datasets.length) {
                      return data.labels.map((label, index) => ({
                        text: `${label}: ${percentages[index]}%`,
                        fillStyle: data.datasets[0].backgroundColor[index],
                        strokeStyle: data.datasets[0].backgroundColor[index],
                        lineWidth: 0,
                        pointStyle: "circle",
                        hidden: false,
                        index: index,
                      }));
                    }
                    return [];
                  },
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                titleColor: "#ffffff",
                bodyColor: "#ffffff",
                borderColor: "#ffffff",
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.parsed;
                    const percentage = ((value / totalAssets) * 100).toFixed(1);
                    return [
                      `${label}: ${percentage}%`,
                      `Value: $${value.toLocaleString()}`,
                    ];
                  },
                },
              },
            },
            interaction: {
              intersect: false,
              mode: "nearest",
            },
            animation: {
              animateRotate: true,
              animateScale: true,
              duration: 1000,
              easing: "easeOutQuart",
            },
            onHover: (event, activeElements, chart) => {
              event.native.target.style.cursor =
                activeElements.length > 0 ? "pointer" : "default";
            },
          },
        });
      }

      // 初始化时使用模拟数据创建图表
      // const mockAssetData = {
      //   cashAmount: 5000,
      //   totalAssets: 17615,
      //   stockHoldings: [
      //     { symbol: "GOOGL", value: 6250 },
      //     { symbol: "MSFT", value: 2800 },
      //     { symbol: "AAPL", value: 1750 },
      //     { symbol: "AMZN", value: 405 },
      //     { symbol: "TSLA", value: 1410 }, // 额外的股票用于测试"其他股票"功能
      //   ],
      // };

      // createAllocationChart(mockAssetData);

      // 调用获取资产信息
      

      // 调用获取持仓信息
      

      // 隐藏/显示余额功能
      const hideBalanceBtn = document.getElementById("hideBalanceBtn");
      const balanceElements = document.querySelectorAll(".card-value, .value");
      // 保存原始值
      balanceElements.forEach((el) => {
        el.setAttribute("data-original", el.textContent);
      });

      hideBalanceBtn.addEventListener("click", async () => {
        const isHidden = hideBalanceBtn
          .querySelector("i")
          .classList.contains("fa-eye");
        if (isHidden) {
          // 显示余额 - 使用缓存数据
          restoreCachedData();
        } else {
          // 隐藏余额
          document.getElementById("totalAssets").textContent = "*****";
          document.getElementById("cashBalance").textContent = "*****";
          document.getElementById("stockHoldings").textContent = "*****";
          document.getElementById("pnl").textContent = "*****";
          
          // 隐藏表格中的价格和价值数据
          const tableBody = document.getElementById('holdingsTableBody');
          const rows = tableBody.querySelectorAll('tr');
          rows.forEach(row => {
            const priceCell = row.querySelector('.price');
            const valueCell = row.querySelector('.value');
            if (priceCell) priceCell.textContent = "*****";
            if (valueCell) valueCell.textContent = "*****";
          });
        }
        // 切换按钮图标和文本
        const icon = hideBalanceBtn.querySelector("i");
        const text = hideBalanceBtn.querySelector("span");
        if (isHidden) {
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
          text.textContent = "Hide Balance";
        } else {
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
          text.textContent = "Show Balance";
        }
      });
      // 退出登录功能
      // const signOutLink = document.getElementById("signOutLink");
      // signOutLink.addEventListener("click", (e) => {
      //   e.preventDefault();
      //   if (confirm("Are you sure you want to sign out?")) {
      //     // 这里可以添加实际的退出登录逻辑
      //     alert("Signing out...");
      //     // 示例：跳转到登录页
      //     // window.location.href = 'login.html';
      //   }
      // });
      // 响应式处理
      function handleResize() {
        if (window.innerWidth >= 769) {
          sidebar.classList.remove("collapsed");
          sidebar.classList.add("expanded");
          mobileOverlay.classList.remove("active");
          const icon = sidebarToggle.querySelector("i");
          icon.classList.remove("fa-chevron-right");
          icon.classList.add("fa-chevron-left");
        } else {
          sidebar.classList.remove("expanded");
          sidebar.classList.add("collapsed");
        }
      }
      // 初始化时调用一次
      handleResize();
      // fetch user asset data

      

      // 监听窗口大小变化
      window.addEventListener("resize", () => {
        if (window.innerWidth >= 769) {
          const sidebar = document.getElementById("sidebar");
          const mobileOverlay = document.getElementById("mobileOverlay");
          const sidebarToggle = document.getElementById("sidebarToggle");

          if (sidebar) {
            sidebar.classList.add("expanded");
            sidebar.classList.remove("collapsed");
          }
          if (mobileOverlay) {
            mobileOverlay.classList.remove("active");
          }
          if (sidebarToggle) {
            sidebarToggle.querySelector("i").className = "fas fa-chevron-left";
          }
        }
      });
    </script>
  </body>
</html>
