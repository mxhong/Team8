<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Market - AssetPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Tailwind 配置 -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "stock-red": "#ff4d4f",
              "stock-green": "#52c41a",
              "light-gray": "#f5f5f5",
              "mid-gray": "#e8e8e8",
              "dark-gray": "#8c8c8c",
              "nav-active": "#fff7f7",
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
        .card-shadow {
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .hover-lift {
          transition: transform 0.2s, box-shadow 0.2s;
        }
        .hover-lift:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        .nav-active {
          background-color: #fff7f7;
          border-left: 4px solid #ff4d4f;
        }
        .search-popup {
          top: 140px;
          max-height: calc(100vh - 160px);
          border: 2px solid #ff4d4f;
          box-shadow: 0 8px 32px rgba(255, 77, 79, 0.15);
        }
        .search-popup-header {
          background: linear-gradient(135deg, #fff7f7 0%, #ffffff 100%);
          border-bottom: 2px solid #ff4d4f;
        }
      }
    </style>
  </head>
  <body class="bg-white font-sans text-gray-800">
    <div class="flex h-screen overflow-hidden">
      <div id="sidebar-container"></div>
      <!-- 主内容区域 -->
      <main
        class="flex-1 min-h-screen bg-[#f8f9fa] flex flex-col overflow-y-auto ml-64"
      >
        <div class="flex-1 flex flex-col px-12 py-8">
          <div class="mb-6">
            <h2 class="text-3xl font-extrabold text-[#222] mb-1">
              Stock Market
            </h2>
            <p class="text-dark-gray mb-4 text-lg">
              Real-time Stock Quotes and Market Data
            </p>
            <div class="relative max-w-2xl mb-6">
              <input
                type="text"
                id="searchInput"
                placeholder="Search for Stock Symbol or Name..."
                class="w-full py-3 px-5 pr-12 border border-mid-gray rounded-xl shadow focus:outline-none focus:ring-2 focus:ring-[#d32f2f]/30 text-lg"
              />
              <button
                id="searchButton"
                onclick="searchStock()"
                class="absolute right-4 top-1/2 transform -translate-y-1/2 text-dark-gray hover:text-[#d32f2f] text-xl"
              >
                <i class="fa fa-search"></i>
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div
              class="bg-white rounded-xl shadow p-6 flex flex-col items-start"
            >
              <span class="text-dark-gray text-lg">Rising Stocks</span>
              <span
                class="text-stock-green text-2xl font-extrabold mt-2"
                id="riseCount"
                >0</span
              >
              <span class="mt-1 text-stock-green text-base flex items-center"
                ><i class="fa fa-arrow-up mr-1"></i
                ><span id="risePercent">0%</span></span
              >
            </div>
            <div
              class="bg-white rounded-xl shadow p-6 flex flex-col items-start"
            >
              <span class="text-dark-gray text-lg">Falling Stocks</span>
              <span
                class="text-stock-red text-2xl font-extrabold mt-2"
                id="fallCount"
                >0</span
              >
              <span class="mt-1 text-stock-red text-base flex items-center"
                ><i class="fa fa-arrow-down mr-1"></i
                ><span id="fallPercent">0%</span></span
              >
            </div>
            <div
              class="bg-white rounded-xl shadow p-6 flex flex-col items-start"
            >
              <span class="text-gray-600 text-lg">Flat Stocks</span>
              <span
                class="text-gray-700 text-2xl font-extrabold mt-2"
                id="flatCount"
                >0</span
              >
              <span class="mt-1 text-gray-600 text-base flex items-center"
                ><i class="fa fa-minus mr-1"></i
                ><span id="flatPercent">0%</span></span
              >
            </div>
          </div>
          <div class="bg-white rounded-xl shadow p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">Popular Stocks</h3>
              <button
                id="refreshHotStocks"
                class="px-3 py-1 bg-[#d32f2f] text-white rounded hover:bg-red-700 text-sm flex items-center"
              >
                <i class="fa fa-refresh mr-1"></i> Refresh
              </button>
            </div>
            <div
              class="grid grid-cols-12 bg-light-gray py-3 px-4 font-medium text-dark-gray text-sm rounded-t-xl"
            >
              <div class="col-span-3">Symbol/Name</div>
              <div class="col-span-2 text-right">Latest Price</div>
              <div class="col-span-2 text-right">Change</div>
              <div class="col-span-2 text-right">Open</div>
              <div class="col-span-2 text-right">High</div>
              <div class="col-span-1 text-right">Volume</div>
            </div>
            <div id="hotStocksList" class="divide-y divide-mid-gray">
              <!-- Stock list items will be dynamically generated by JavaScript -->
            </div>
          </div>
        </div>
        <!-- 搜索结果弹窗 -->
        <div
          id="searchResultsPopup"
          class="fixed bg-gray-500 bg-opacity-50 flex items-start justify-center hidden z-20"
          style="left: -2cm; top: 1.5cm; right: 0; bottom: 0"
        >
          <div
            class="bg-white p-6 rounded-lg shadow-xl relative w-full max-w-4xl max-h-[70vh] overflow-auto search-popup"
            style="border: none"
          >
            <div
              class="flex justify-between items-center mb-4 sticky top-0 bg-white z-10 pb-2 search-popup-header"
            >
              <h3 class="text-lg font-bold text-stock-red">Search Results</h3>
              <button
                onclick="closeSearchPopup()"
                class="text-gray-500 hover:text-stock-red transition-colors"
              >
                <i class="fa fa-times"></i>
              </button>
            </div>
            <div class="bg-white rounded-lg overflow-hidden card-shadow">
              <div
                class="grid grid-cols-9 bg-light-gray py-2 px-4 font-medium text-dark-gray text-sm"
              >
                <div class="col-span-2">Symbol/Name</div>
                <div class="col-span-1 text-right">Open</div>
                <div class="col-span-1 text-right">High</div>
                <div class="col-span-1 text-right">Low</div>
                <div class="col-span-1 text-right">Close</div>
                <div class="col-span-2 text-right">Change</div>
              </div>
              <div id="searchResultsList" class="divide-y divide-mid-gray">
                <!-- Search results will be dynamically generated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Global variables
      let currentSymbol = null;
      let stockChart = null;
      let currentInterval = "1day";

      const HOT_STOCKS_CACHE_KEY = "hotStocksCache";
      const HOT_STOCKS_CACHE_DURATION = 5 * 60 * 60 * 1000; // 5hours refresh

      // Execute when DOM elements are loaded
      document.addEventListener("DOMContentLoaded", async () => {
        fetch("/sidebar.html")
          .then((response) => response.text())
          .then((html) => {
            document.getElementById("sidebar-container").innerHTML = html;

            // 侧边栏加载完成后，手动设置当前页面的活跃状态
            setTimeout(() => {
              const navItems = document.querySelectorAll(".sidebar-nav a");
              navItems.forEach((item) => {
                item.classList.remove("active");
                if (item.getAttribute("href") === "stock.html") {
                  item.classList.add("active");
                }
              });
            }, 100);
          })
          .catch((error) => console.error("加载侧边栏失败:", error));
        try {
          console.log("DOMContentLoaded");
          // checkLoginStatus();
          showLoadingHotStocks();
          const stocks = await getHotStocks();
          console.log("Initial hot stocks loaded:", stocks);
          renderHotStocks(stocks);
          document
            .getElementById("searchInput")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                searchStock();
              }
            });
          document.getElementById("refreshHotStocks").onclick = async () => {
            try {
              console.log("Refresh button clicked");
              localStorage.removeItem(HOT_STOCKS_CACHE_KEY);
              showLoadingHotStocks();
              const stocks = await getHotStocks(true);
              console.log("Hot stocks after refresh:", stocks);
              renderHotStocks(stocks);
            } catch (err) {
              console.error("Error in refreshHotStocks click:", err);
              alert("Failed to refresh hot stocks. See console for details.");
            }
          };
        } catch (e) {
          console.error("DOMContentLoaded error:", e);
          alert("Page initialization error. See console for details.");
        }
      });

      async function getHotStocks(forceRefresh = false) {
        try {
          console.log("getHotStocks called, forceRefresh:", forceRefresh);
          const cache = JSON.parse(
            localStorage.getItem(HOT_STOCKS_CACHE_KEY) || "null"
          );
          const now = Date.now();

          if (
            !forceRefresh &&
            cache &&
            now - cache.timestamp < HOT_STOCKS_CACHE_DURATION
          ) {
            console.log("Using cached hot stocks:", cache.data);
            return cache.data;
          }

          // 重新请求API
          const hotSymbols = [
            "AAPL",
            "MSFT",
            "GOOGL",
            "AMZN",
            "TSLA",
            "META",
            "NVDA",
            "BABA",
          ];
          const results = [];
          for (const symbol of hotSymbols) {
            try {
              console.log("Fetching:", symbol);
              const res = await fetch(
                `/api/stock/quote/${symbol}?_=${Date.now()}`
              );
              if (!res.ok) throw new Error("API error");
              const data = await res.json();
              results.push(data);
            } catch (e) {
              console.error("Error fetching", symbol, e);
              results.push({ symbol, error: true });
            }
          }
          // 存入缓存
          localStorage.setItem(
            HOT_STOCKS_CACHE_KEY,
            JSON.stringify({
              data: results,
              timestamp: now,
            })
          );
          console.log("Fetched and cached hot stocks:", results);
          return results;
        } catch (err) {
          console.error("getHotStocks error:", err);
          alert("Failed to load hot stocks. See console for details.");
          return [];
        }
      }

      function renderHotStocks(stocks) {
        try {
          console.log("Rendering hot stocks:", stocks);
          const hotStocksList = document.getElementById("hotStocksList");
          hotStocksList.innerHTML = "";
          let riseCount = 0;
          let fallCount = 0;
          let flatCount = 0;

          stocks.forEach((stock) => {
            if (stock.error) {
              const errorItem = document.createElement("div");
              errorItem.className =
                "grid grid-cols-12 py-3 px-4 hover:bg-light-gray transition-colors cursor-pointer";
              errorItem.innerHTML = `
              <div class="col-span-3 flex flex-col">
                <span class="font-medium">${stock.symbol}</span>
                <span class="text-sm text-dark-gray">${
                  stock.name || stock.description || getStockName(stock.symbol)
                }</span>
              </div>
              <div class="col-span-9 flex items-center justify-center text-red-500">
                <i class="fa fa-exclamation-triangle mr-2"></i>
                Failed to load data: ${stock.error}
              </div>
            `;
              hotStocksList.appendChild(errorItem);
            } else {
              const stockData = {
                symbol: stock.symbol,
                name:
                  stock.name || stock.description || getStockName(stock.symbol),
                price: stock.close || stock.price,
                change: stock.change || 0,
                percent_change: stock.percent_change || 0,
                open: stock.open,
                high: stock.high,
                volume: stock.volume,
              };
              const isRise = parseFloat(stockData.change) >= 0;
              const changeClass = isRise
                ? "text-stock-green"
                : "text-stock-red";
              const changeIcon = isRise ? "fa-arrow-up" : "fa-arrow-down";
              const item = document.createElement("div");
              item.className =
                "grid grid-cols-12 py-3 px-4 hover:bg-light-gray transition-colors hover-lift cursor-pointer";
              item.onclick = () => {
                window.location.href = `stock-detail.html?symbol=${stockData.symbol}`;
              };
              item.innerHTML = `
              <div class="col-span-3 flex flex-col">
                <span class="font-medium">${stockData.symbol}</span>
                <span class="text-sm text-dark-gray">${
                  stockData.name || "-"
                }</span>
              </div>
              <div class="col-span-2 flex items-center justify-end font-medium">${formatPrice(
                stockData.price
              )}</div>
              <div class="col-span-2 flex items-center justify-end ${changeClass}">
                <i class="fa ${changeIcon} mr-1 text-xs"></i>
                ${formatChange(stockData.change, stockData.percent_change)}
              </div>
              <div class="col-span-2 flex items-center justify-end">${formatPrice(
                stockData.open
              )}</div>
              <div class="col-span-2 flex items-center justify-end">${formatPrice(
                stockData.high
              )}</div>
              <div class="col-span-1 flex items-center justify-end text-sm text-dark-gray">
                ${stockData.volume ? formatNumber(stockData.volume) : "-"}
              </div>
            `;
              hotStocksList.appendChild(item);

              // Update market overview data
              if (isRise) riseCount++;
              else if (parseFloat(stockData.change) < 0) fallCount++;
              else flatCount++;
            }
          });

          // Update market overview data
          document.getElementById("riseCount").textContent = riseCount;
          document.getElementById("fallCount").textContent = fallCount;
          document.getElementById("flatCount").textContent = flatCount;
          // Calculate percentages
          const total = stocks.length;
          document.getElementById("risePercent").textContent =
            ((riseCount / total) * 100).toFixed(1) + "%";
          document.getElementById("fallPercent").textContent =
            ((fallCount / total) * 100).toFixed(1) + "%";
          document.getElementById("flatPercent").textContent =
            (((total - riseCount - fallCount) / total) * 100).toFixed(1) + "%";
          console.log(`Loaded ${total} stocks successfully`);
        } catch (err) {
          console.error("renderHotStocks error:", err);
          alert("Failed to render hot stocks. See console for details.");
        }
      }

      function showLoadingHotStocks() {
        const hotStocksList = document.getElementById("hotStocksList");
        hotStocksList.innerHTML = `
        <div class="py-4 px-4 text-center text-dark-gray">
          <i class="fa fa-spinner fa-spin mr-2"></i>Fetching latest data...
        </div>
      `;
      }

      // Helper function to get stock name
      function getStockName(symbol) {
        const stockNames = {
          AAPL: "Apple Inc.",
          MSFT: "Microsoft Corporation",
          GOOGL: "Alphabet Inc.",
          AMZN: "Amazon.com Inc.",
          TSLA: "Tesla Inc.",
          META: "Meta Platforms Inc.",
          NVDA: "NVIDIA Corporation",
          BABA: "Alibaba Group Holding Limited",
        };
        return stockNames[symbol] || symbol;
      }

      // Create stock list item
      function createStockListItem(stockData) {
        const isRise = parseFloat(stockData.change) >= 0;
        const changeClass = isRise ? "text-stock-green" : "text-stock-red";
        const changeIcon = isRise ? "fa-arrow-up" : "fa-arrow-down";
        const item = document.createElement("div");
        item.className =
          "grid grid-cols-12 py-3 px-4 hover:bg-light-gray transition-colors hover-lift cursor-pointer";

        // Click to navigate to detail page
        item.onclick = () => {
          window.location.href = `stock-detail.html?symbol=${stockData.symbol}`;
        };

        // Format price values with 2 decimal places
        const formatPrice = (value) => {
          if (!value || isNaN(value)) return "-";
          return `$${parseFloat(value).toFixed(2)}`;
        };

        // Format change values
        const formatChange = (change, percent) => {
          if (!change || isNaN(change)) return "-";
          const changeValue = parseFloat(change);
          const percentValue = parseFloat(percent);
          const sign = changeValue >= 0 ? "+" : "";
          const percentSign = percentValue >= 0 ? "+" : "";
          return `${sign}${changeValue.toFixed(
            2
          )} (${percentSign}${percentValue.toFixed(2)}%)`;
        };

        item.innerHTML = `
        <div class="col-span-3 flex flex-col">
          <span class="font-medium">${stockData.symbol}</span>
          <span class="text-sm text-dark-gray">${stockData.name || "-"}</span>
        </div>
        <div class="col-span-2 flex items-center justify-end font-medium">${formatPrice(
          stockData.price
        )}</div>
        <div class="col-span-2 flex items-center justify-end ${changeClass}">
          <i class="fa ${changeIcon} mr-1 text-xs"></i>
          ${formatChange(stockData.change, stockData.percent_change)}
        </div>
        <div class="col-span-2 flex items-center justify-end">${formatPrice(
          stockData.open
        )}</div>
        <div class="col-span-2 flex items-center justify-end">${formatPrice(
          stockData.high
        )}</div>
        <div class="col-span-1 flex items-center justify-end text-sm text-dark-gray">
          ${stockData.volume ? formatNumber(stockData.volume) : "-"}
        </div>
      `;
        return item;
      }

      // Search for stocks
      async function searchStock() {
        const keywords = document.getElementById("searchInput").value.trim();
        if (!keywords) return;

        const searchResultsList = document.getElementById("searchResultsList");
        searchResultsList.innerHTML = "";

        try {
          console.log(`Searching for: ${keywords}`);

          // Call backend API to get stock information
          const response = await fetch(
            `/api/stock/quote/${encodeURIComponent(keywords)}`
          );
          console.log(`Search response:`, response.status, response.statusText);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          console.log(`Search data:`, data);

          if (data.code && data.status === "error") {
            throw new Error(data.message);
          }

          document
            .getElementById("searchResultsPopup")
            .classList.remove("hidden");

          // Display search results
          searchResultsList.innerHTML = `
          <div class="grid grid-cols-9 py-3 px-4 hover:bg-light-gray transition-colors hover-lift cursor-pointer" id="search-stock-item">
            <div class="col-span-2 flex flex-col">
              <span class="font-medium">${data.symbol || "-"}</span>
              <span class="text-sm text-dark-gray">${
                data.name || data.description || "-"
              }</span>
            </div>
            <div class="col-span-1 flex items-center justify-end font-medium">${formatPrice(
              data.open
            )}</div>
            <div class="col-span-1 flex items-center justify-end font-medium">${formatPrice(
              data.high
            )}</div>
            <div class="col-span-1 flex items-center justify-end font-medium">${formatPrice(
              data.low
            )}</div>
            <div class="col-span-1 flex items-center justify-end font-medium">${formatPrice(
              data.close || data.price
            )}</div>
            <div class="col-span-2 flex items-center justify-end font-medium">
              <span class="${
                parseFloat(data.change || 0) >= 0
                  ? "text-stock-green"
                  : "text-stock-red"
              }">
                <i class="fa ${
                  parseFloat(data.change || 0) >= 0
                    ? "fa-arrow-up"
                    : "fa-arrow-down"
                } mr-1 text-xs"></i>
                ${formatChange(data.change || 0, data.percent_change || 0)}
              </span>
            </div>
          </div>
        `;

          // Click to navigate to detail page
          const itemDiv = document.getElementById("search-stock-item");
          if (itemDiv) {
            itemDiv.onclick = () => {
              window.location.href = `stock-detail.html?symbol=${data.symbol}`;
            };
          }
        } catch (error) {
          console.error("Search error:", error);
          document
            .getElementById("searchResultsPopup")
            .classList.remove("hidden");
          searchResultsList.innerHTML = `
          <div class="py-6 px-4 text-center text-dark-gray">
            <i class="fa fa-exclamation-triangle mr-2 text-red-500"></i>
            No matching stocks found for "${keywords}"
            <br><span class="text-sm text-red-500">${error.message}</span>
          </div>
        `;
        }
      }

      // Close search results popup
      function closeSearchPopup() {
        document.getElementById("searchResultsPopup").classList.add("hidden");
      }

      // Check login status
      // function checkLoginStatus() {
      //   const isLoggedIn = localStorage.getItem("isLoggedIn");
      //   const userEmail = localStorage.getItem("userEmail");

      //   if (!isLoggedIn || !userEmail) {
      //     // If not logged in, redirect to login page
      //     window.location.href = "login.html";
      //     return;
      //   }

      //   // Update user information display
      //   document.getElementById("username").textContent = userEmail;
      // }

      // Logout functionality
      // document
      //   .getElementById("logout-btn")
      //   .addEventListener("click", function () {
      //     localStorage.removeItem("userEmail");
      //     localStorage.removeItem("isLoggedIn");
      //     window.location.href = "index.html";
      //   });

      // Utility function: format price values
      function formatPrice(value) {
        if (!value || isNaN(value)) return "-";
        return `$${parseFloat(value).toFixed(2)}`;
      }

      // Utility function: format change values
      function formatChange(change, percent) {
        if (!change || isNaN(change)) return "-";
        const changeValue = parseFloat(change);
        const percentValue = parseFloat(percent);
        const sign = changeValue >= 0 ? "+" : "";
        const percentSign = percentValue >= 0 ? "+" : "";
        return `${sign}${changeValue.toFixed(
          2
        )} (${percentSign}${percentValue.toFixed(2)}%)`;
      }

      // Utility function: format numbers (add thousand separators)
      function formatNumber(num) {
        if (!num) return "0";
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
    </script>
  </body>
</html>
